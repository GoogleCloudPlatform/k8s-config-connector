apiVersion: memorystore.cnrm.cloud.google.com/v1alpha1
kind: MemorystoreInstance
metadata:
  finalizers:
  - cnrm.cloud.google.com/finalizer
  - cnrm.cloud.google.com/deletion-defender
  generation: 2
  labels:
    cnrm-test: "true"
  name: memorystore-${uniqueId}
  namespace: ${uniqueId}
spec:
  authorizationMode: IAM_AUTH
  deletionProtectionEnabled: false
  endpoints:
  - connections:
    - pscAutoConnection:
        networkRef:
          external: projects/${projectId}/global/networks/computenetwork-${uniqueId}
        projectRef:
          external: ${projectId}
  engineConfigs:
    maxclients: "10000"
    maxmemory-policy: volatile-ttl
  engineVersion: VALKEY_7_2
  labels:
    key1: val1
    key2: val2
    keyx: valx
  location: us-central1
  mode: CLUSTER
  nodeType: STANDARD_SMALL
  persistenceConfig:
    aofConfig:
      appendFsync: EVERY_SEC
    mode: RDB
    rdbConfig:
      rdbSnapshotPeriod: ONE_HOUR
      rdbSnapshotStartTime: "2025-10-02T15:01:23Z"
  projectRef:
    external: ${projectId}
  replicaCount: 1
  shardCount: 12
  transitEncryptionMode: SERVER_AUTHENTICATION
  zoneDistributionConfig:
    mode: SINGLE_ZONE
    zone: us-central1-b
status:
  conditions:
  - lastTransitionTime: "1970-01-01T00:00:00Z"
    message: |-
      Update call failed: error updating: updating instance projects/${projectId}/locations/us-central1/instances/memorystore-${uniqueId}: googleapi: Error 400: invalid argument: prepareUpdate failed: unable to update RDB and AOF config at the same time
      req: update_mask:{paths:"persistence_config"}  instance:{name:"projects/${projectId}/locations/us-central1/instances/memorystore-${uniqueId}"  labels:{key:"key1"  value:"val1"}  labels:{key:"key2"  value:"val2"}  labels:{key:"keyx"  value:"valx"}  replica_count:1  authorization_mode:IAM_AUTH  transit_encryption_mode:SERVER_AUTHENTICATION  shard_count:12  node_type:STANDARD_SMALL  persistence_config:{mode:RDB  rdb_config:{rdb_snapshot_period:ONE_HOUR  rdb_snapshot_start_time:{seconds:1759417283}}  aof_config:{append_fsync:EVERY_SEC}}  engine_version:"VALKEY_7_2"  engine_configs:{key:"maxclients"  value:"10000"}  engine_configs:{key:"maxmemory-policy"  value:"volatile-ttl"}  zone_distribution_config:{zone:"us-central1-b"  mode:SINGLE_ZONE}  deletion_protection_enabled:false  endpoints:{connections:{psc_auto_connection:{project_id:"${projectId}"  network:"projects/${projectId}/global/networks/computenetwork-${uniqueId}"}}}  mode:CLUSTER}
      error details: name = DebugInfo detail = generic::invalid_argument: invalid argument: prepareUpdate failed: unable to update RDB and AOF config at the same time
      req: update_mask:{paths:"persistence_config"}  instance:{name:"projects/${projectId}/locations/us-central1/instances/memorystore-${uniqueId}"  labels:{key:"key1"  value:"val1"}  labels:{key:"key2"  value:"val2"}  labels:{key:"keyx"  value:"valx"}  replica_count:1  authorization_mode:IAM_AUTH  transit_encryption_mode:SERVER_AUTHENTICATION  shard_count:12  node_type:STANDARD_SMALL  persistence_config:{mode:RDB  rdb_config:{rdb_snapshot_period:ONE_HOUR  rdb_snapshot_start_time:{seconds:1759417283}}  aof_config:{append_fsync:EVERY_SEC}}  engine_version:"VALKEY_7_2"  engine_configs:{key:"maxclients"  value:"10000"}  engine_configs:{key:"maxmemory-policy"  value:"volatile-ttl"}  zone_distribution_config:{zone:"us-central1-b"  mode:SINGLE_ZONE}  deletion_protection_enabled:false  endpoints:{connections:{psc_auto_connection:{project_id:"${projectId}"  network:"projects/${projectId}/global/networks/computenetwork-${uniqueId}"}}}  mode:CLUSTER} stack = cloud/control2/shared/userfriendly/userfriendly.go:1375 +0x25 google3/cloud/control2/shared/userfriendly/userfriendly.DebugInfoWithMessage({0xc026eda900, 0x434}) cloud/control2/shared/userfriendly/userfriendly.go:1370 +0x2b google3/cloud/control2/shared/userfriendly/userfriendly.debugInfoWithError({0x55983614e9e0?, 0xc033fa9900?}) cloud/control2/shared/userfriendly/userfriendly.go:1259 +0x247 google3/cloud/control2/shared/userfriendly/userfriendly.FromExternalUserFriendlyStatus({0x5598362bcf78, 0xc01977bb60}, {0x559828938d47, 0xd}, 0xc033fa9900, 0x1, 0x0) cloud/control2/frontend/clhprotocol/clh_client.go:193 +0x60d google3/cloud/control2/frontend/clhprotocol/clhclient.CLHClient.callBackendMethod({0x5598353379a0?}, {0x5598362bcf78, 0xc01977bb60}, {0xc029918210, 0xb}, 0x94626834a6, {0x5598362ac258, 0xc025044460}, {0x55983614e418, 0xc031302a40}, ...) cloud/control2/frontend/clhprotocol/clh_client.go:57 +0x78 google3/cloud/control2/frontend/clhprotocol/clhclient.CLHClient.CallPreprocess({0xc0260462a8?}, {0x5598362bcf78, 0xc01977bb60}, 0x0, {0xc029918210?, 0x0?}, 0xc0026eb320?, 0xc00b783a00?, {0x55983614e418, 0xc031302a40}, ...) cloud/control2/frontend/handler/mutate.go:490 +0x2c98 google3/cloud/control2/frontend/handler/handler.Handler.handleResourceMutation({{0x7fe4447ef288, 0xc005b06280}, {0xc00db55518, 0xc00dce9c40, {0x5598362ed740, 0xc00baea0c0}, 0xc0026eb320, 0xc025044320}, {{0x559836156a20, 0xc00b782900}}, ...}, ...) cloud/control2/frontend/handler/handler.go:416 +0xc5b google3/cloud/control2/frontend/handler/handler.Handler.start({{0x7fe4447ef288, 0xc005b06280}, {0xc00db55518, 0xc00dce9c40, {0x5598362ed740, 0xc00baea0c0}, 0xc0026eb320, 0xc025044320}, {{0x559836156a20, 0xc00b782900}}, ...}, ...) cloud/control2/frontend/handler/handler.go:316 +0x5e google3/cloud/control2/frontend/handler/handler.init.func26({0x5598362bcf78?, 0xc01977bb60?}, {{0x7fe4447ef288, 0xc005b06280}, {0xc00db55518, 0xc00dce9c40, {0x5598362ed740, 0xc00baea0c0}, 0xc0026eb320, 0xc025044320}, ...}, ...) cloud/control2/frontend/handler/handler.go:311 +0x131 google3/cloud/control2/frontend/handler/handler.Handler.HandleRequest({{0x7fe4447ef288, 0xc005b06280}, {0xc00db55518, 0xc00dce9c40, {0x5598362ed740, 0xc00baea0c0}, 0xc0026eb320, 0xc025044320}, {{0x559836156a20, 0xc00b782900}}, ...}, ...) cloud/control2/frontend/server/request_handler.go:117 +0x516 google3/cloud/control2/frontend/server/requesthandler.(*Handler).handleRequestWithFullMethodName(0xc0124acb60, {0x5598362bcf78, 0xc01977b620}, 0xc004088280, 0xc024b402d0, 0xc02268a960, {0xc02bb493e0?, 0x0?}) cloud/control2/frontend/server/request_handler.go:90 +0x516 google3/cloud/control2/frontend/server/requesthandler.(*Handler).handleRequest(0xc0124acb60, {0x5598362bcf78, 0xc01977b620}, 0xc024b402d0, 0xc02268a960) cloud/control2/frontend/server/request_handler.go:59 +0xd5 google3/cloud/control2/frontend/server/requesthandler.(*Handler).handle(0xc0124acb60, {0x5598362bcf78, 0xc01977b620}, 0xc024b402d0, 0xc02268a960) cloud/control2/shared/genericrpc/service.go:171 +0x3e8 google3/cloud/control2/shared/genericrpc/genericrpc.(*Dispatcher).DefaultMethodHandler(0xc00acc3080, {0x5598362bcf78, 0xc01977b620}, 0xc024b402d0) net/rpc/go/stream.go:1175 +0x43 google3/net/rpc/go/rpc.runStreamHandler({0x5598362bcf78?, 0xc01977b620?}, 0xc024b402d0?, {0x0?, 0x0?}, {0x5598362d3c40, 0xc025044280}) net/goa/rpc/rpchandler.go:100 +0x4d7 google3/net/goa/rpc/rpchandler.ExecHandlerSubset({0x5598362bcf78?, 0xc02a99ce70?}, 0xc026047550) net/goa/rpc/rpchandler.go:327 +0x9d5 google3/net/goa/rpc/rpchandler.(*closedRegistry).hook(0xc0123b8f40, {0x5598362bd5b8, 0xc02442b2c0}, 0xc03209c680) production/fireaxe/go/filters/rpcserverinterceptor.go:62 +0x2f0 google3/production/fireaxe/go/filters/rpcserverinterceptor.(*Interceptor).MakeHook-fm.(*Interceptor).MakeHook.func2({0x5598362bd5b8, 0xc02442b2c0}, 0xc03209c680)
    reason: UpdateFailed
    status: "False"
    type: Ready
  externalRef: projects/${projectId}/locations/us-central1/instances/memorystore-${uniqueId}
  observedGeneration: 2
  observedState:
    createTime: "1970-01-01T00:00:00Z"
    endpoints:
    - connections:
      - pscAutoConnection:
          connectionType: CONNECTION_TYPE_DISCOVERY
          forwardingRule: https://www.googleapis.com/compute/v1/projects/${projectId}/regions/us-central1/forwardingRules/sca-auto-fr-7a741054-5a86-43e2-8b93-ed26e450297e
          ipAddress: 10.128.0.2
          port: 6379
          pscConnectionID: "77188976326213634"
          serviceAttachment: projects/32205071991/regions/us-central1/serviceAttachments/gcp-memorystore-auto-m7ed83dfea675cc7-psc-sa
      - pscAutoConnection:
          forwardingRule: https://www.googleapis.com/compute/v1/projects/${projectId}/regions/us-central1/forwardingRules/sca-auto-fr-eaccf9fb-fc9d-48f0-8193-e3e965ebeb27
          ipAddress: 10.128.0.3
          port: 6379
          pscConnectionID: "77188976326213635"
          serviceAttachment: projects/32205071991/regions/us-central1/serviceAttachments/gcp-memorystore-auto-m7ed83dfea675cc7-psc-sa-2
    nodeConfig:
      sizeGB: 6.5
    state: ACTIVE
    uid: 0123456789abcdef
    updateTime: "1970-01-01T00:00:00Z"
