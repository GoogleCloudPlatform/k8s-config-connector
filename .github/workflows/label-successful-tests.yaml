# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Label Successful Tests

on:
  workflow_run:
    workflows: ["presubmit", "ci-presubmit", "fuzz"]
    types:
      - completed

jobs:
  label-on-success:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'pull_request' }}
    permissions:
      pull-requests: write
      issues: write
    steps:
      - name: Get PR number
        id: get-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const run_id = context.payload.workflow_run.id;

            const runResponse = await github.rest.actions.listWorkflowRunPullRequests({
              owner,
              repo,
              run_id
            });

            // Fix: The response structure is different
            if (runResponse.data.length === 0) {
              console.log('No PRs found for this workflow run');
              return;
            }

            const prNumber = runResponse.data[0].number;
            core.setOutput("pr_number", prNumber);
      
      - name: Add label to PR
        if: ${{ steps.get-pr.outputs.pr_number }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr_number = parseInt('${{ steps.get-pr.outputs.pr_number }}');
            const { owner, repo } = context.repo;

            console.log(`Adding 'test-passed' label to PR #${pr_number}`);

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr_number,
              labels: ['test-passed']
            });