{
  "name": "generate-summary",
  "description": "Generates a summary of CRD changes and a comparison of release files.",
  "steps": [
    {
      "name": "Get CRD Commit Hash",
      "description": "Gets the commit hash of the 'Update alpha CRDs' commit.",
      "actions": [
        {
          "run": "git log --grep='^Update alpha CRDs for Release ' --pretty=format:%H -n 1",
          "id": "commit2_hash"
        }
      ]
    },
    {
      "name": "Create CRD Diff File",
      "description": "Creates a temporary diff file for the 'Update alpha CRDs' commit.",
      "actions": [
        {
          "run": "if [ -n \"${commit2_hash.stdout}\" ]; then git diff ${commit2_hash.stdout}^! > crd_commit.diff.tmp; fi"
        }
      ]
    },
    {
      "name": "Process 'Update alpha CRDs' Commit Diff",
      "description": "Counts version updates and removes blocks with only version changes from the 'Update alpha CRDs' commit diff.",
      "actions": [
        {
          "run": "if [ -f crd_commit.diff.tmp ]; then grep -cE '^[-]    cnrm.cloud.google.com/version:' crd_commit.diff.tmp; fi",
          "id": "version_update_count2"
        },
        {
          "run": "if [ -f crd_commit.diff.tmp ]; then echo \"Number of version updates: ${version_update_count2.stdout}\" > crd_commit.diff; fi"
        },
        {
          "run": "if [ -f crd_commit.diff.tmp ]; then echo \"============================================\" >> crd_commit.diff; fi"
        },
        {
          "run": "if [ -f crd_commit.diff.tmp ]; then python3 dev/tasks/filter_version_changes.py crd_commit.diff.tmp >> crd_commit.diff; fi"
        },
        {
          "run": "rm -f crd_commit.diff.tmp"
        }
      ]
    },
    {
      "name": "Finalize",
      "actions": [
        {
          "echo": "Processed CRD diff is in crd_commit.diff and release artifacts comparison is in release_artifacts_comparison.diff"
        }
      ]
    }
  ]
}