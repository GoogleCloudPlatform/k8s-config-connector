#!/bin/bash
# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -o errexit
set -o nounset
set -o pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"

if [[ -z "${VERSION:-}" ]]; then
  echo "Error: VERSION environment variable must be set for release verification (e.g., VERSION=1.12.0)."
  exit 1
fi

TARGET_CRD_DIR=${REPO_ROOT}/crds
TEMP_HYDRATED_MASTER=$(mktemp -td verify-release-crds-hydrated.XXXXXXXX)
TEMP_OFFICIAL_RELEASE=$(mktemp -td verify-release-crds-official.XXXXXXXX)

# 1. Hydration: Take the master CRDs and substitute ${CNRM_VERSION} with the actual release version.
echo "Hydrating master CRDs from ${TARGET_CRD_DIR} with version ${VERSION}..."
cp -r ${TARGET_CRD_DIR}/* ${TEMP_HYDRATED_MASTER}/
for filepath in ${TEMP_HYDRATED_MASTER}/*.yaml; do
    sed -i "s/cnrm.cloud.google.com\/version: .*/cnrm.cloud.google.com\/version: ${VERSION}/g" ${filepath}
done

# 2. Preparation of Official Release CRDs:
# These are generated from the source of truth (config/crds/resources).
echo "Generating official release CRDs from config/crds/resources for version ${VERSION}..."
CRDS_FILE=$(mktemp)
first=true
for f in ${REPO_ROOT}/config/crds/resources/*.yaml; do
  if [ "$first" = false ]; then
    echo "---" >> ${CRDS_FILE}
  fi
  cat "$f" >> ${CRDS_FILE}
  first=false
done

# Split the combined official CRDs using parse-crds.go
# This ensures they have the same structure and filenames as master CRDs.
cd ${REPO_ROOT} && go run -mod=readonly ${REPO_ROOT}/scripts/parse-crds/parse-crds.go \
    -file ${CRDS_FILE} \
    -output-dir ${TEMP_OFFICIAL_RELEASE}

# Add generated file markers and inject the real version to match hydrated master.
for filepath in ${TEMP_OFFICIAL_RELEASE}/*.yaml; do
    TMP_FILE=$(mktemp)
    echo "# Generated by dev/tasks/sync-crds-folder.sh. DO NOT EDIT." > ${TMP_FILE}
    # Replace whatever version is there (usually 0.0.0-dev) with the actual release version.
    sed "s/cnrm.cloud.google.com\/version: .*/cnrm.cloud.google.com\/version: ${VERSION}/g" ${filepath} >> ${TMP_FILE}
    mv ${TMP_FILE} ${filepath}
done

# 3. Verification: Compare "Hydrated Master CRDs" against "Prepared Official Release CRDs"
echo "Verifying that the hydrated master CRDs match the official release CRDs..."

if ! diff -r -u ${TEMP_HYDRATED_MASTER} ${TEMP_OFFICIAL_RELEASE}; then
    echo "----------------------------------------------------------------------"
    echo "Error: Structural schema changes detected between master and release CRDs!"
    echo "Workflow: FAILED."
    echo "ACTION REQUIRED: Human verification and approval requested."
    echo "Please review the differences above. If they are intentional, "
    echo "update the master CRDs by running 'dev/tasks/sync-crds-folder.sh' and commit them."
    exit 1
fi

echo "Pass: The check passes. Hydrated master CRDs are identical to official release CRDs."
echo "Workflow: PASS. Automatically proceeding with the release."

rm -rf ${TEMP_HYDRATED_MASTER} ${TEMP_OFFICIAL_RELEASE} ${CRDS_FILE}