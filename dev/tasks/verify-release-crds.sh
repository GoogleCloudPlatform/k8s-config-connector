#!/bin/bash
# Copyright 2024 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -o errexit
set -o nounset
set -o pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"

if [[ -z "${VERSION:-}" ]]; then
  echo "Error: VERSION environment variable must be set for release verification (e.g., VERSION=1.12.0)."
  exit 1
fi

TARGET_CRD_DIR=${REPO_ROOT}/crds
TEMP_OFFICIAL_DIR=$(mktemp -td verify-release-crds-official.XXXXXXXX)

# 1. Preparation of Official Release CRDs:
# These are the ones generated by the current code for the release.
echo "Generating official release CRDs from config/crds/resources for version ${VERSION}..."
CRDS_FILE=$(mktemp)
first=true
for f in ${REPO_ROOT}/config/crds/resources/*.yaml; do
  if [ "$first" = false ]; then
    echo "---" >> ${CRDS_FILE}
  fi
  cat "$f" >> ${CRDS_FILE}
  first=false
done

# Split the combined official CRDs
cd ${REPO_ROOT} && go run -mod=readonly ${REPO_ROOT}/scripts/parse-crds/parse-crds.go \
    -file ${CRDS_FILE} \
    -output-dir ${TEMP_OFFICIAL_DIR}

# Add generated file markers and inject the real version to create "Hydrated Release CRDs"
for filepath in ${TEMP_OFFICIAL_DIR}/*.yaml; do
    TMP_FILE=$(mktemp)
    echo "# Generated by dev/tasks/sync-crds-folder.sh. DO NOT EDIT." > ${TMP_FILE}
    # Replace the version with the actual release version
    sed "s/cnrm.cloud.google.com\/version: .*/cnrm.cloud.google.com\/version: ${VERSION}/g" ${filepath} >> ${TMP_FILE}
    mv ${TMP_FILE} ${filepath}
done

# 2. Verification: Compare "Hydrated Release CRDs" against "Parameterized Master CRDs"
echo "Verifying that the semantic difference is exactly the version number change..."

# We use diff and check if any lines other than the version change exist.
# We exclude the +++ and --- file markers from diff -u.
DIFF_OUTPUT=$(diff -r -u ${TARGET_CRD_DIR} ${TEMP_OFFICIAL_DIR} || true)

if [[ -z "${DIFF_OUTPUT}" ]]; then
    echo "Warning: No differences found. This might mean the master CRDs were already hydrated with ${VERSION}."
else
    # Filter out expected version differences and diff markers
    # Expected differences look like:
    # -    cnrm.cloud.google.com/version: ${CNRM_VERSION}
    # +    cnrm.cloud.google.com/version: 1.143.0
    STRUCTURAL_DIFF=$(echo "${DIFF_OUTPUT}" | grep "^[+-]" | grep -v "^+++" | grep -v "^---" | grep -v "cnrm.cloud.google.com/version: " || true)

    if [[ -n "${STRUCTURAL_DIFF}" ]]; then
        echo "Error: Structural schema changes detected between master and release CRDs!"
        echo "The following unexpected changes were found:"
        echo "${STRUCTURAL_DIFF}"
        echo "----------------------------------------------------------------------"
        echo "Workflow: FAILED. Human verification/approval requested."
        exit 1
    fi
fi

echo "Pass: The check passes. The only difference is the version number change."
rm -rf ${TEMP_OFFICIAL_DIR} ${CRDS_FILE}
